name: Auto-Label Issues (Reusable)

on:
  workflow_call:
    inputs:
      issue_number:
        description: 'Issue number'
        required: true
        type: number
      issue_body:
        description: 'Issue body content'
        required: true
        type: string
      repo_name:
        description: 'Repository name'
        required: true
        type: string

jobs:
  auto-label:
    runs-on: ubuntu-latest
    steps:
      - name: Auto-label issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ inputs.issue_number }};
            const body = `${{ inputs.issue_body }}`;
            const repoName = '${{ inputs.repo_name }}';
            const labelsToAdd = [];

            console.log(`Processing issue #${issueNumber} in ${repoName}`);

            // NOTE: Type and Platform are set as Project Fields, not labels
            // Only Area labels are added here

            // === AREA LABELS (from body) ===
            const areaMatch = body.match(/### Affected Area[s]?\s*\n\s*([^\n#]+)/i);
            if (areaMatch) {
              const areas = areaMatch[1].split(',').map(a => a.trim().toLowerCase());

              const areaMapping = {
                'assets': 'ðŸš› Assets',
                'assets (trucks/trailers/drivers)': 'ðŸš› Assets',
                'orders': 'ðŸ“¦ Orders',
                'pre-bookings': 'ðŸ“… Pre-bookings',
                'transactions': 'ðŸ’³ Transactions',
                'weighbridge operations': 'âš–ï¸ Weighbridge',
                'weighbridge': 'âš–ï¸ Weighbridge',
                'security checkpoints': 'ðŸ”’ Security',
                'security': 'ðŸ”’ Security',
                'induction': 'ðŸ“‹ Induction',
                'induction (asset onboarding)': 'ðŸ“‹ Induction',
                'sites': 'ðŸ“ Sites',
                'sites (configuration)': 'ðŸ“ Sites',
                'companies': 'ðŸ¢ Companies',
                'companies (multi-tenant)': 'ðŸ¢ Companies',
                'dashboards': 'ðŸ“Š Dashboards',
                'dashboards (mine/lc/transporter)': 'ðŸ“Š Dashboards',
                'admin/settings': 'âš™ï¸ Admin',
                'admin': 'âš™ï¸ Admin',
                'ui/ux': 'ðŸŽ¨ UI',
                'ui': 'ðŸŽ¨ UI',
                'pdf generation': 'ðŸ“„ PDF',
                'pdf': 'ðŸ“„ PDF',
                'notifications': 'ðŸ”” Notifications',
                'api': 'ðŸ”Œ API',
                'authentication/permissions': 'ðŸ” Auth',
                'auth': 'ðŸ” Auth',
                'mfa': 'ðŸ“² MFA'
              };

              for (const area of areas) {
                const label = areaMapping[area];
                if (label && !labelsToAdd.includes(label)) {
                  labelsToAdd.push(label);
                }
              }
            }

            // === APPLY LABELS ===
            if (labelsToAdd.length > 0) {
              console.log(`Adding area labels: ${labelsToAdd.join(', ')}`);

              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  labels: labelsToAdd
                });
                console.log('Labels added successfully');
              } catch (error) {
                console.log(`Error adding labels: ${error.message}`);
                // Try one by one
                for (const label of labelsToAdd) {
                  try {
                    await github.rest.issues.addLabels({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issueNumber,
                      labels: [label]
                    });
                    console.log(`Added label: ${label}`);
                  } catch (e) {
                    console.log(`Failed to add label "${label}": ${e.message}`);
                  }
                }
              }
            } else {
              console.log('No area labels to add');
            }
