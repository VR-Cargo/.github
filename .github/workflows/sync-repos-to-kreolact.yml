# Automatically sync VR-Cargo repos to kreolact
# - Creates missing repos in kreolact  
# - Adds mirror.yml workflow to repos that don't have it

name: Sync Repos to kreolact

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no changes)'
        required: false
        default: 'false'
        type: boolean

jobs:
  sync:
    name: Sync repositories
    runs-on: ubuntu-latest
    steps:
      - name: Sync repos to kreolact
        env:
          GH_TOKEN: ${{ secrets.KREOLACT_MIRROR_PAT }}
        run: |
          echo "üîç Checking VR-Cargo repos..."
          
          VR_CARGO_REPOS=$(gh repo list VR-Cargo --json name --jq '.[].name')
          
          CREATED_REPOS=""
          ADDED_WORKFLOWS=""
          SKIPPED_EMPTY=""
          
          for repo in $VR_CARGO_REPOS; do
            if [ "$repo" = ".github" ]; then
              continue
            fi
            
            echo ""
            echo "üì¶ Processing $repo"
            target="$repo"
            
            # Check/create kreolact repo
            if gh repo view "kreolact/$target" &>/dev/null; then
              echo "  ‚úÖ kreolact/$target exists"
            else
              echo "  ‚ö†Ô∏è  kreolact/$target does not exist"
              if [ "${{ inputs.dry_run }}" = "true" ]; then
                echo "  üî∏ DRY RUN: Would create kreolact/$target"
              else
                visibility=$(gh repo view "VR-Cargo/$repo" --json visibility --jq '.visibility' | tr '[:upper:]' '[:lower:]')
                description=$(gh repo view "VR-Cargo/$repo" --json description --jq '.description // empty')
                echo "  üî® Creating kreolact/$target (${visibility})..."
                if [ -n "$description" ]; then
                  gh repo create "kreolact/$target" --"$visibility" --description "Mirror of VR-Cargo/$repo - $description"
                else
                  gh repo create "kreolact/$target" --"$visibility" --description "Mirror of VR-Cargo/$repo"
                fi
                CREATED_REPOS="$CREATED_REPOS\n  - kreolact/$target"
                echo "  ‚úÖ Created kreolact/$target"
              fi
            fi
            
            # Check if repo is empty
            DEFAULT_BRANCH=$(gh repo view "VR-Cargo/$repo" --json defaultBranchRef --jq '.defaultBranchRef.name // empty')
            if [ -z "$DEFAULT_BRANCH" ]; then
              echo "  ‚è≠Ô∏è  VR-Cargo/$repo is empty - skipping mirror.yml"
              SKIPPED_EMPTY="$SKIPPED_EMPTY\n  - VR-Cargo/$repo"
              continue
            fi
            
            # Check/add mirror workflow
            if ! gh api "repos/VR-Cargo/$repo/contents/.github/workflows/mirror.yml" &>/dev/null; then
              echo "  ‚ö†Ô∏è  VR-Cargo/$repo missing mirror.yml"
              if [ "${{ inputs.dry_run }}" = "true" ]; then
                echo "  üî∏ DRY RUN: Would add mirror.yml"
              else
                echo "  üî® Adding mirror.yml to VR-Cargo/$repo..."
                
                # Generate workflow content with repo name substituted
                WORKFLOW=$(cat << WFEOF
# Mirror this repo to kreolact organization
name: Mirror to kreolact

on:
  push:
    branches: [main]
    tags: ['**']

jobs:
  mirror:
    name: Mirror to kreolact/${repo}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          persist-credentials: false
      - name: Push mirror
        env:
          PAT: \${{ secrets.KREOLACT_MIRROR_PAT }}
        run: |
          git config --global user.email "mirror@vr-cargo.com"
          git config --global user.name "VR-Cargo Mirror"
          git remote add kreolact "https://\${PAT}@github.com/kreolact/${repo}.git"
          git push kreolact --all --force
          git push kreolact --tags --force
WFEOF
)
                
                ENCODED=$(echo "$WORKFLOW" | base64 -w 0)
                
                if gh api "repos/VR-Cargo/$repo/contents/.github/workflows/mirror.yml" \
                  -X PUT \
                  -f message="feat: Add mirror workflow for kreolact sync" \
                  -f content="$ENCODED" \
                  -f branch="$DEFAULT_BRANCH" \
                  --silent 2>/dev/null; then
                  ADDED_WORKFLOWS="$ADDED_WORKFLOWS\n  - VR-Cargo/$repo"
                  echo "  ‚úÖ Added mirror.yml"
                else
                  echo "  ‚ùå Failed to add mirror.yml"
                fi
              fi
            fi
          done
          
          # Handle .github repo
          echo ""
          echo "üì¶ Processing .github -> vr-cargo-github"
          if gh repo view "kreolact/vr-cargo-github" &>/dev/null; then
            echo "  ‚úÖ kreolact/vr-cargo-github exists"
          else
            if [ "${{ inputs.dry_run }}" != "true" ]; then
              gh repo create "kreolact/vr-cargo-github" --private --description "Mirror of VR-Cargo/.github"
              CREATED_REPOS="$CREATED_REPOS\n  - kreolact/vr-cargo-github"
            fi
          fi
          
          echo ""
          echo "================================"
          echo "üìä SUMMARY"
          echo "================================"
          
          if [ -n "$CREATED_REPOS" ]; then
            echo -e "\n‚ú® Created repos:$CREATED_REPOS"
          fi
          if [ -n "$ADDED_WORKFLOWS" ]; then
            echo -e "\n‚ú® Added mirror.yml:$ADDED_WORKFLOWS"
          fi
          if [ -n "$SKIPPED_EMPTY" ]; then
            echo -e "\n‚è≠Ô∏è Skipped empty repos:$SKIPPED_EMPTY"
          fi
          if [ -z "$CREATED_REPOS" ] && [ -z "$ADDED_WORKFLOWS" ] && [ -z "$SKIPPED_EMPTY" ]; then
            echo -e "\n‚úÖ All repos synced!"
          fi
