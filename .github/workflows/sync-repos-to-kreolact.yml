# Automatically sync VR-Cargo repos to kreolact
# - Creates missing repos in kreolact
# - Adds mirror.yml workflow directly to repos (org admins bypass branch protection)

name: Sync Repos to kreolact

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no changes)'
        required: false
        default: 'false'
        type: boolean

env:
  # Base64 encoded mirror workflow template (REPO_PLACEHOLDER will be replaced)
  # Uses persist-credentials:false and credential store for proper auth
  MIRROR_TEMPLATE: bmFtZTogTWlycm9yIHRvIGtyZW9sYWN0CgpvbjoKICBwdXNoOgogICAgYnJhbmNoZXM6IFttYWluXQogIHdvcmtmbG93X2Rpc3BhdGNoOgoKam9iczoKICBtaXJyb3I6CiAgICBpZjogZ2l0aHViLnJlcG9zaXRvcnlfb3duZXIgPT0gJ1ZSLUNhcmdvJwogICAgcnVucy1vbjogdWJ1bnR1LWxhdGVzdAogICAgc3RlcHM6CiAgICAgIC0gbmFtZTogQ2hlY2tvdXQgc291cmNlCiAgICAgICAgdXNlczogYWN0aW9ucy9jaGVja291dEB2NAogICAgICAgIHdpdGg6CiAgICAgICAgICBmZXRjaC1kZXB0aDogMAogICAgICAgICAgcGVyc2lzdC1jcmVkZW50aWFsczogZmFsc2UKCiAgICAgIC0gbmFtZTogUmVtb3ZlIC5naXRodWIgYW5kIG1pcnJvciB0byBrcmVvbGFjdAogICAgICAgIGVudjoKICAgICAgICAgIEdIX1RPS0VOOiAke3sgc2VjcmV0cy5DUk9TU19SRVBPX1BBVCB9fQogICAgICAgIHJ1bjogfAogICAgICAgICAgIyBDb25maWd1cmUgZ2l0CiAgICAgICAgICBnaXQgY29uZmlnIHVzZXIubmFtZSAiR2l0SHViIEFjdGlvbnMiCiAgICAgICAgICBnaXQgY29uZmlnIHVzZXIuZW1haWwgImFjdGlvbnNAZ2l0aHViLmNvbSIKICAgICAgICAgIAogICAgICAgICAgIyBSZW1vdmUgLmdpdGh1YiBmb2xkZXIKICAgICAgICAgIGdpdCBybSAtcmYgLmdpdGh1YgogICAgICAgICAgZ2l0IGNvbW1pdCAtbSAiY2hvcmU6IFJlbW92ZSAuZ2l0aHViIGZvbGRlciBmb3Iga3Jlb2xhY3QgbWlycm9yIgogICAgICAgICAgCiAgICAgICAgICAjIFNldCB1cCBjcmVkZW50aWFsIGhlbHBlciB0byB1c2Ugb3VyIHRva2VuCiAgICAgICAgICBnaXQgY29uZmlnIC0tZ2xvYmFsIGNyZWRlbnRpYWwuaGVscGVyIHN0b3JlCiAgICAgICAgICBlY2hvICJodHRwczovL3gtYWNjZXNzLXRva2VuOiR7R0hfVE9LRU59QGdpdGh1Yi5jb20iID4gfi8uZ2l0LWNyZWRlbnRpYWxzCiAgICAgICAgICAKICAgICAgICAgICMgQWRkIHJlbW90ZSBhbmQgcHVzaAogICAgICAgICAgZ2l0IHJlbW90ZSBhZGQga3Jlb2xhY3QgImh0dHBzOi8vZ2l0aHViLmNvbS9rcmVvbGFjdC9SRVBPX1BMQUNFSE9MREVSLmdpdCIKICAgICAgICAgIGdpdCBwdXNoIC0tZm9yY2Uga3Jlb2xhY3QgSEVBRDptYWluCg==

jobs:
  sync:
    name: Sync repositories
    runs-on: ubuntu-latest
    steps:
      - name: Sync repos to kreolact
        env:
          GH_TOKEN: ${{ secrets.CROSS_REPO_PAT }}
          MIRROR_TEMPLATE: ${{ env.MIRROR_TEMPLATE }}
        run: |
          echo "üîç Checking VR-Cargo repos..."

          VR_CARGO_REPOS=$(gh repo list VR-Cargo --json name --jq '.[].name')

          CREATED_REPOS=""
          ADDED_WORKFLOWS=""
          SKIPPED_EMPTY=""

          for repo in $VR_CARGO_REPOS; do
            [ "$repo" = ".github" ] && continue

            echo ""
            echo "üì¶ Processing $repo"

            # Create kreolact repo if missing
            if ! gh repo view "kreolact/$repo" &>/dev/null; then
              echo "  ‚ö†Ô∏è  kreolact/$repo does not exist"
              if [ "${{ inputs.dry_run }}" != "true" ]; then
                visibility=$(gh repo view "VR-Cargo/$repo" --json visibility --jq '.visibility' | tr '[:upper:]' '[:lower:]')
                description=$(gh repo view "VR-Cargo/$repo" --json description --jq '.description // empty')
                echo "  üî® Creating kreolact/$repo..."
                gh repo create "kreolact/$repo" --"$visibility" --description "Mirror of VR-Cargo/$repo${description:+ - $description}"
                CREATED_REPOS="$CREATED_REPOS\n  - kreolact/$repo"
                echo "  ‚úÖ Created"
              fi
            else
              echo "  ‚úÖ kreolact/$repo exists"
            fi

            # Check if repo has content
            DEFAULT_BRANCH=$(gh repo view "VR-Cargo/$repo" --json defaultBranchRef --jq '.defaultBranchRef.name // empty')
            if [ -z "$DEFAULT_BRANCH" ]; then
              echo "  ‚è≠Ô∏è Empty repo - skipping"
              SKIPPED_EMPTY="$SKIPPED_EMPTY\n  - VR-Cargo/$repo"
              continue
            fi

            # Check if mirror workflow exists
            if ! gh api "repos/VR-Cargo/$repo/contents/.github/workflows/mirror.yml" &>/dev/null; then
              echo "  ‚ö†Ô∏è  Missing mirror.yml"

              if [ "${{ inputs.dry_run }}" != "true" ]; then
                echo "  üî® Adding mirror.yml directly..."

                # Decode template and replace placeholder
                CONTENT=$(echo "$MIRROR_TEMPLATE" | base64 -d | sed "s/REPO_PLACEHOLDER/$repo/g" | base64)

                # Create the workflow file directly on default branch (org admin bypass)
                if gh api "repos/VR-Cargo/$repo/contents/.github/workflows/mirror.yml" \
                  -X PUT \
                  -f message="feat: Add mirror workflow for kreolact sync" \
                  -f content="$CONTENT" \
                  -f branch="$DEFAULT_BRANCH" \
                  --silent 2>/dev/null; then
                  ADDED_WORKFLOWS="$ADDED_WORKFLOWS\n  - VR-Cargo/$repo"
                  echo "  ‚úÖ Added mirror.yml"
                else
                  echo "  ‚ùå Failed to add mirror.yml (check PAT permissions)"
                fi
              fi
            fi
          done

          # .github repo
          echo ""
          echo "üì¶ Processing .github -> vr-cargo-github"
          if ! gh repo view "kreolact/vr-cargo-github" &>/dev/null; then
            [ "${{ inputs.dry_run }}" != "true" ] && gh repo create "kreolact/vr-cargo-github" --private --description "Mirror of VR-Cargo/.github"
          else
            echo "  ‚úÖ exists"
          fi

          echo ""
          echo "========================================"
          echo "üìä SUMMARY"
          echo "========================================"
          [ -n "$CREATED_REPOS" ] && echo -e "\n‚ú® Created kreolact repos:$CREATED_REPOS"
          [ -n "$ADDED_WORKFLOWS" ] && echo -e "\n‚ú® Added mirror.yml to:$ADDED_WORKFLOWS"
          [ -n "$SKIPPED_EMPTY" ] && echo -e "\n‚è≠Ô∏è Skipped empty repos:$SKIPPED_EMPTY"
          [ -z "$CREATED_REPOS$ADDED_WORKFLOWS$SKIPPED_EMPTY" ] && echo -e "\n‚úÖ All repos synced and have mirror workflows!"

          echo ""
          echo "Sync complete!"
