# Automatically sync VR-Cargo repos to kreolact
# - Creates missing repos in kreolact
# - Adds mirror.yml workflow directly to repos (org admins bypass branch protection)

name: Sync Repos to kreolact

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no changes)'
        required: false
        default: 'false'
        type: boolean

env:
  # Base64 encoded mirror workflow template (REPO_PLACEHOLDER will be replaced)
  MIRROR_TEMPLATE: IyBNaXJyb3IgdGhpcyByZXBvIHRvIGtyZW9sYWN0IG9yZ2FuaXphdGlvbgpuYW1lOiBNaXJyb3IgdG8ga3Jlb2xhY3QKCm9uOgogIHB1c2g6CiAgICBicmFuY2hlczogW21haW5dCiAgICB0YWdzOiBbJyoqJ10KCmpvYnM6CiAgbWlycm9yOgogICAgbmFtZTogTWlycm9yIHRvIGtyZW9sYWN0L1JFUE9fUExBQ0VIT0xERVIKICAgIHJ1bnMtb246IHVidW50dS1sYXRlc3QKICAgIHN0ZXBzOgogICAgICAtIHVzZXM6IGFjdGlvbnMvY2hlY2tvdXRAdjQKICAgICAgICB3aXRoOgogICAgICAgICAgZmV0Y2gtZGVwdGg6IDAKICAgICAgICAgIGZldGNoLXRhZ3M6IHRydWUKICAgICAgICAgIHBlcnNpc3QtY3JlZGVudGlhbHM6IGZhbHNlCiAgICAgIC0gbmFtZTogUHVzaCBtaXJyb3IKICAgICAgICBlbnY6CiAgICAgICAgICBQQVQ6ICR7eyBzZWNyZXRzLktSRU9MQUNUX01JUlJPUl9QQVQgfX0KICAgICAgICBydW46IHwKICAgICAgICAgIGdpdCBjb25maWcgLS1nbG9iYWwgdXNlci5lbWFpbCAibWlycm9yQHZyLWNhcmdvLmNvbSIKICAgICAgICAgIGdpdCBjb25maWcgLS1nbG9iYWwgdXNlci5uYW1lICJWUi1DYXJnbyBNaXJyb3IiCiAgICAgICAgICBnaXQgcmVtb3RlIGFkZCBrcmVvbGFjdCAiaHR0cHM6Ly8ke1BBVH1AZ2l0aHViLmNvbS9rcmVvbGFjdC9SRVBPX1BMQUNFSE9MREVSLmdpdCIKICAgICAgICAgIGdpdCBwdXNoIGtyZW9sYWN0IC0tYWxsIC0tZm9yY2UKICAgICAgICAgIGdpdCBwdXNoIGtyZW9sYWN0IC0tdGFncyAtLWZvcmNlCg==

jobs:
  sync:
    name: Sync repositories
    runs-on: ubuntu-latest
    steps:
      - name: Sync repos to kreolact
        env:
          GH_TOKEN: ${{ secrets.KREOLACT_MIRROR_PAT }}
          MIRROR_TEMPLATE: ${{ env.MIRROR_TEMPLATE }}
        run: |
          echo "üîç Checking VR-Cargo repos..."

          VR_CARGO_REPOS=$(gh repo list VR-Cargo --json name --jq '.[].name')

          CREATED_REPOS=""
          ADDED_WORKFLOWS=""
          SKIPPED_EMPTY=""

          for repo in $VR_CARGO_REPOS; do
            [ "$repo" = ".github" ] && continue

            echo ""
            echo "üì¶ Processing $repo"

            # Create kreolact repo if missing
            if ! gh repo view "kreolact/$repo" &>/dev/null; then
              echo "  ‚ö†Ô∏è  kreolact/$repo does not exist"
              if [ "${{ inputs.dry_run }}" != "true" ]; then
                visibility=$(gh repo view "VR-Cargo/$repo" --json visibility --jq '.visibility' | tr '[:upper:]' '[:lower:]')
                description=$(gh repo view "VR-Cargo/$repo" --json description --jq '.description // empty')
                echo "  üî® Creating kreolact/$repo..."
                gh repo create "kreolact/$repo" --"$visibility" --description "Mirror of VR-Cargo/$repo${description:+ - $description}"
                CREATED_REPOS="$CREATED_REPOS\n  - kreolact/$repo"
                echo "  ‚úÖ Created"
              fi
            else
              echo "  ‚úÖ kreolact/$repo exists"
            fi

            # Check if repo has content
            DEFAULT_BRANCH=$(gh repo view "VR-Cargo/$repo" --json defaultBranchRef --jq '.defaultBranchRef.name // empty')
            if [ -z "$DEFAULT_BRANCH" ]; then
              echo "  ‚è≠Ô∏è Empty repo - skipping"
              SKIPPED_EMPTY="$SKIPPED_EMPTY\n  - VR-Cargo/$repo"
              continue
            fi

            # Check if mirror workflow exists
            if ! gh api "repos/VR-Cargo/$repo/contents/.github/workflows/mirror.yml" &>/dev/null; then
              echo "  ‚ö†Ô∏è  Missing mirror.yml"

              if [ "${{ inputs.dry_run }}" != "true" ]; then
                echo "  üî® Adding mirror.yml directly..."

                # Decode template and replace placeholder
                CONTENT=$(echo "$MIRROR_TEMPLATE" | base64 -d | sed "s/REPO_PLACEHOLDER/$repo/g" | base64)

                # Create the workflow file directly on default branch (org admin bypass)
                if gh api "repos/VR-Cargo/$repo/contents/.github/workflows/mirror.yml" \
                  -X PUT \
                  -f message="feat: Add mirror workflow for kreolact sync" \
                  -f content="$CONTENT" \
                  -f branch="$DEFAULT_BRANCH" \
                  --silent 2>/dev/null; then
                  ADDED_WORKFLOWS="$ADDED_WORKFLOWS\n  - VR-Cargo/$repo"
                  echo "  ‚úÖ Added mirror.yml"
                else
                  echo "  ‚ùå Failed to add mirror.yml (check PAT permissions)"
                fi
              fi
            fi
          done

          # .github repo
          echo ""
          echo "üì¶ Processing .github -> vr-cargo-github"
          if ! gh repo view "kreolact/vr-cargo-github" &>/dev/null; then
            [ "${{ inputs.dry_run }}" != "true" ] && gh repo create "kreolact/vr-cargo-github" --private --description "Mirror of VR-Cargo/.github"
          else
            echo "  ‚úÖ exists"
          fi

          echo ""
          echo "========================================"
          echo "üìä SUMMARY"
          echo "========================================"
          [ -n "$CREATED_REPOS" ] && echo -e "\n‚ú® Created kreolact repos:$CREATED_REPOS"
          [ -n "$ADDED_WORKFLOWS" ] && echo -e "\n‚ú® Added mirror.yml to:$ADDED_WORKFLOWS"
          [ -n "$SKIPPED_EMPTY" ] && echo -e "\n‚è≠Ô∏è Skipped empty repos:$SKIPPED_EMPTY"
          [ -z "$CREATED_REPOS$ADDED_WORKFLOWS$SKIPPED_EMPTY" ] && echo -e "\n‚úÖ All repos synced and have mirror workflows!"
