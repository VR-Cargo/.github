# Automatically sync VR-Cargo repos to kreolact
# - Creates missing repos in kreolact
# - Creates PRs to add mirror.yml to repos that don't have it

name: Sync Repos to kreolact

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no changes)'
        required: false
        default: 'false'
        type: boolean

env:
  # Base64 encoded mirror workflow template (REPO_PLACEHOLDER will be replaced)
  MIRROR_TEMPLATE: IyBNaXJyb3IgdGhpcyByZXBvIHRvIGtyZW9sYWN0IG9yZ2FuaXphdGlvbgpuYW1lOiBNaXJyb3IgdG8ga3Jlb2xhY3QKCm9uOgogIHB1c2g6CiAgICBicmFuY2hlczogW21haW5dCiAgICB0YWdzOiBbJyoqJ10KCmpvYnM6CiAgbWlycm9yOgogICAgbmFtZTogTWlycm9yIHRvIGtyZW9sYWN0L1JFUE9fUExBQ0VIT0xERVIKICAgIHJ1bnMtb246IHVidW50dS1sYXRlc3QKICAgIHN0ZXBzOgogICAgICAtIHVzZXM6IGFjdGlvbnMvY2hlY2tvdXRAdjQKICAgICAgICB3aXRoOgogICAgICAgICAgZmV0Y2gtZGVwdGg6IDAKICAgICAgICAgIGZldGNoLXRhZ3M6IHRydWUKICAgICAgICAgIHBlcnNpc3QtY3JlZGVudGlhbHM6IGZhbHNlCiAgICAgIC0gbmFtZTogUHVzaCBtaXJyb3IKICAgICAgICBlbnY6CiAgICAgICAgICBQQVQ6ICR7eyBzZWNyZXRzLktSRU9MQUNUX01JUlJPUl9QQVQgfX0KICAgICAgICBydW46IHwKICAgICAgICAgIGdpdCBjb25maWcgLS1nbG9iYWwgdXNlci5lbWFpbCAibWlycm9yQHZyLWNhcmdvLmNvbSIKICAgICAgICAgIGdpdCBjb25maWcgLS1nbG9iYWwgdXNlci5uYW1lICJWUi1DYXJnbyBNaXJyb3IiCiAgICAgICAgICBnaXQgcmVtb3RlIGFkZCBrcmVvbGFjdCAiaHR0cHM6Ly8ke1BBVH1AZ2l0aHViLmNvbS9rcmVvbGFjdC9SRVBPX1BMQUNFSE9MREVSLmdpdCIKICAgICAgICAgIGdpdCBwdXNoIGtyZW9sYWN0IC0tYWxsIC0tZm9yY2UKICAgICAgICAgIGdpdCBwdXNoIGtyZW9sYWN0IC0tdGFncyAtLWZvcmNlCg==

jobs:
  sync:
    name: Sync repositories
    runs-on: ubuntu-latest
    steps:
      - name: Sync repos to kreolact
        env:
          GH_TOKEN: ${{ secrets.KREOLACT_MIRROR_PAT }}
          MIRROR_TEMPLATE: ${{ env.MIRROR_TEMPLATE }}
        run: |
          echo "üîç Checking VR-Cargo repos..."
          
          VR_CARGO_REPOS=$(gh repo list VR-Cargo --json name --jq '.[].name')
          
          CREATED_REPOS=""
          CREATED_PRS=""
          SKIPPED_EMPTY=""
          EXISTING_PRS=""
          
          for repo in $VR_CARGO_REPOS; do
            [ "$repo" = ".github" ] && continue
            
            echo ""
            echo "üì¶ Processing $repo"
            
            # Create kreolact repo if missing
            if ! gh repo view "kreolact/$repo" &>/dev/null; then
              echo "  ‚ö†Ô∏è  kreolact/$repo does not exist"
              if [ "${{ inputs.dry_run }}" != "true" ]; then
                visibility=$(gh repo view "VR-Cargo/$repo" --json visibility --jq '.visibility' | tr '[:upper:]' '[:lower:]')
                description=$(gh repo view "VR-Cargo/$repo" --json description --jq '.description // empty')
                echo "  üî® Creating kreolact/$repo..."
                gh repo create "kreolact/$repo" --"$visibility" --description "Mirror of VR-Cargo/$repo${description:+ - $description}"
                CREATED_REPOS="$CREATED_REPOS\n  - kreolact/$repo"
                echo "  ‚úÖ Created"
              fi
            else
              echo "  ‚úÖ kreolact/$repo exists"
            fi
            
            # Check if repo has content
            DEFAULT_BRANCH=$(gh repo view "VR-Cargo/$repo" --json defaultBranchRef --jq '.defaultBranchRef.name // empty')
            if [ -z "$DEFAULT_BRANCH" ]; then
              echo "  ‚è≠Ô∏è Empty repo - skipping"
              SKIPPED_EMPTY="$SKIPPED_EMPTY\n  - VR-Cargo/$repo"
              continue
            fi
            
            # Check if mirror workflow exists
            if ! gh api "repos/VR-Cargo/$repo/contents/.github/workflows/mirror.yml" &>/dev/null; then
              echo "  ‚ö†Ô∏è  Missing mirror.yml"
              
              # Check if PR already exists
              EXISTING_PR=$(gh pr list --repo "VR-Cargo/$repo" --head "auto/add-mirror-workflow" --json number --jq '.[0].number // empty')
              if [ -n "$EXISTING_PR" ]; then
                echo "  üìã PR #$EXISTING_PR already exists"
                EXISTING_PRS="$EXISTING_PRS\n  - VR-Cargo/$repo#$EXISTING_PR"
                continue
              fi
              
              if [ "${{ inputs.dry_run }}" != "true" ]; then
                echo "  üî® Creating PR to add mirror.yml..."
                
                # Create branch and add workflow file
                BRANCH_NAME="auto/add-mirror-workflow"
                
                # Get the latest commit SHA of default branch
                BASE_SHA=$(gh api "repos/VR-Cargo/$repo/git/ref/heads/$DEFAULT_BRANCH" --jq '.object.sha')
                
                # Create the branch
                if gh api "repos/VR-Cargo/$repo/git/refs" -X POST \
                  -f ref="refs/heads/$BRANCH_NAME" \
                  -f sha="$BASE_SHA" --silent 2>/dev/null; then
                  
                  # Decode template and replace placeholder
                  CONTENT=$(echo "$MIRROR_TEMPLATE" | base64 -d | sed "s/REPO_PLACEHOLDER/$repo/g" | base64 -w 0)
                  
                  # Create the workflow file on the new branch
                  if gh api "repos/VR-Cargo/$repo/contents/.github/workflows/mirror.yml" \
                    -X PUT \
                    -f message="feat: Add mirror workflow for kreolact sync" \
                    -f content="$CONTENT" \
                    -f branch="$BRANCH_NAME" \
                    --silent 2>/dev/null; then
                    
                    # Create the PR
                    PR_URL=$(gh pr create --repo "VR-Cargo/$repo" \
                      --head "$BRANCH_NAME" \
                      --base "$DEFAULT_BRANCH" \
                      --title "feat: Add mirror workflow for kreolact sync" \
                      --body "## Summary
          This PR adds a workflow to automatically mirror this repository to kreolact.

          ## What it does
          - Mirrors all branches and tags to \`kreolact/$repo\`
          - Triggers on every push to main branch

          ---
          ü§ñ Auto-generated by VR-Cargo repo sync workflow")
                    
                    CREATED_PRS="$CREATED_PRS\n  - $PR_URL"
                    echo "  ‚úÖ Created PR: $PR_URL"
                  else
                    echo "  ‚ùå Failed to create workflow file"
                    # Clean up branch
                    gh api "repos/VR-Cargo/$repo/git/refs/heads/$BRANCH_NAME" -X DELETE --silent 2>/dev/null || true
                  fi
                else
                  echo "  ‚ùå Failed to create branch (may already exist)"
                fi
              fi
            fi
          done
          
          # .github repo
          echo ""
          echo "üì¶ Processing .github -> vr-cargo-github"
          if ! gh repo view "kreolact/vr-cargo-github" &>/dev/null; then
            [ "${{ inputs.dry_run }}" != "true" ] && gh repo create "kreolact/vr-cargo-github" --private --description "Mirror of VR-Cargo/.github"
          else
            echo "  ‚úÖ exists"
          fi
          
          echo ""
          echo "========================================"
          echo "üìä SUMMARY"
          echo "========================================"
          [ -n "$CREATED_REPOS" ] && echo -e "\n‚ú® Created kreolact repos:$CREATED_REPOS"
          [ -n "$CREATED_PRS" ] && echo -e "\nüìã Created PRs (merge to enable mirroring):$CREATED_PRS"
          [ -n "$EXISTING_PRS" ] && echo -e "\nüìã Existing PRs (waiting for merge):$EXISTING_PRS"
          [ -n "$SKIPPED_EMPTY" ] && echo -e "\n‚è≠Ô∏è Skipped empty repos:$SKIPPED_EMPTY"
          [ -z "$CREATED_REPOS$CREATED_PRS$EXISTING_PRS$SKIPPED_EMPTY" ] && echo -e "\n‚úÖ All repos synced and have mirror workflows!"
