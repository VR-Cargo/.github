name: Sync Issue Priority to Project (Reusable)

on:
  workflow_call:
    inputs:
      issue_body:
        description: 'The body content of the issue'
        required: true
        type: string
      issue_node_id:
        description: 'The node_id of the issue'
        required: true
        type: string
    secrets:
      CROSS_REPO_PAT:
        description: 'GitHub token with project write permissions'
        required: true

jobs:
  sync-priority:
    runs-on: ubuntu-latest
    steps:
      - name: Parse Priority from Issue Body
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = `${{ inputs.issue_body }}`;

            // Parse priority from issue body (both bug and feature templates)
            // Looks for: ### Priority\n\nNormal|High|Critical
            const priorityMatch = body.match(/### Priority\s*\n\s*(Normal|High|Critical)/i);

            let priority = null;

            if (priorityMatch) {
              priority = priorityMatch[1]; // Normal, High, or Critical
            }

            console.log(`Parsed priority: ${priority}`);
            core.setOutput('priority', priority || '');
            return priority;

      - name: Wait for Project Auto-Add
        if: steps.parse.outputs.priority != ''
        run: sleep 15

      - name: Update Project Priority
        if: steps.parse.outputs.priority != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.CROSS_REPO_PAT }}
          script: |
            const priority = '${{ steps.parse.outputs.priority }}';
            const issueNodeId = `${{ inputs.issue_node_id }}`;

            // Get the project and field info
            // VR-Cargo MVP Project number is 1
            const projectQuery = `
              query($org: String!, $number: Int!) {
                organization(login: $org) {
                  projectV2(number: $number) {
                    id
                    field(name: "Priority") {
                      ... on ProjectV2SingleSelectField {
                        id
                        options {
                          id
                          name
                        }
                      }
                    }
                  }
                }
              }
            `;

            const projectData = await github.graphql(projectQuery, {
              org: 'VR-Cargo',
              number: 1
            });

            const project = projectData.organization.projectV2;
            const priorityField = project.field;

            if (!priorityField || !priorityField.options) {
              console.log('Priority field not found or not a single-select field');
              return;
            }

            // Map Normal/High/Critical to project field emoji option names
            const priorityMapping = {
              'Normal': 'ðŸŸ¢ Normal',
              'High': 'ðŸŸ¡ High',
              'Critical': 'ðŸ”´ Critical'
            };

            const targetOptionName = priorityMapping[priority];
            if (!targetOptionName) {
              console.log(`Unknown priority: ${priority}`);
              return;
            }

            // Find the option ID for the mapped priority name
            const option = priorityField.options.find(opt => opt.name === targetOptionName);

            if (!option) {
              console.log(`Priority option "${targetOptionName}" not found in project field`);
              console.log('Available options:', priorityField.options.map(o => o.name));
              return;
            }

            console.log(`Mapping ${priority} -> ${targetOptionName} (option ID: ${option.id})`);

            // Query the issue directly to get its project items
            const issueItemsQuery = `
              query($issueId: ID!) {
                node(id: $issueId) {
                  ... on Issue {
                    projectItems(first: 10) {
                      nodes {
                        id
                        project {
                          id
                        }
                      }
                    }
                  }
                }
              }
            `;

            let projectItem = null;
            const maxRetries = 5;

            for (let attempt = 1; attempt <= maxRetries; attempt++) {
              console.log(`Attempt ${attempt}/${maxRetries}: Searching for issue in project...`);

              const result = await github.graphql(issueItemsQuery, {
                issueId: issueNodeId
              });

              const items = result.node?.projectItems?.nodes || [];
              projectItem = items.find(item => item.project.id === project.id);

              if (projectItem) {
                console.log(`Found issue in project! Item ID: ${projectItem.id}`);
                break;
              }

              if (attempt < maxRetries) {
                console.log(`Issue not in project yet, waiting 10s...`);
                await new Promise(r => setTimeout(r, 10000));
              }
            }

            if (!projectItem) {
              console.log('Issue not found in project after retries. Attempting to add...');

              const addItemMutation = `
                mutation($projectId: ID!, $contentId: ID!) {
                  addProjectV2ItemById(input: {
                    projectId: $projectId
                    contentId: $contentId
                  }) {
                    item {
                      id
                    }
                  }
                }
              `;

              try {
                const addResult = await github.graphql(addItemMutation, {
                  projectId: project.id,
                  contentId: issueNodeId
                });
                projectItem = addResult.addProjectV2ItemById.item;
                console.log(`Added issue to project. Item ID: ${projectItem.id}`);
              } catch (error) {
                console.log(`Failed to add issue to project: ${error.message}`);
                return;
              }
            }

            // Update the priority field
            const updateMutation = `
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(
                  input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: { singleSelectOptionId: $optionId }
                  }
                ) {
                  projectV2Item {
                    id
                  }
                }
              }
            `;

            await github.graphql(updateMutation, {
              projectId: project.id,
              itemId: projectItem.id,
              fieldId: priorityField.id,
              optionId: option.id
            });

            console.log(`Successfully set priority to ${priority} (${targetOptionName})`);
